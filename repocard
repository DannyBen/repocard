#!/usr/bin/env bash
# Simple SVG generator driven by .repocard.conf
# Usage: repocard > repocard.svg

set -euo pipefail

version=0.2.0

caption="Repo Card"
cols=4
width=180
height=65
gap=12
padding=16
title_height=28
bg="f7f7f5"
bg_dark="161b22"
title="1f2328"
title_dark="f0f6fc"
label="5a6572"
label_dark="8b949e"
border="e6e6e2"
border_dark="30363d"
card="ffffff"
card_dark="0d1117"

green="22C55E"
green_dark="22C55E"
yellow="EAB308"
yellow_dark="EAB308"
orange="F97316"
orange_dark="F97316"
red="EF4444"
red_dark="EF4444"
blue="3B82F6"
blue_dark="3B82F6"
neutral="8F8F8F"
neutral_dark="A3A3A3"
strong="222222"
strong_dark="dddddd"

items=()

trim() {
  local s="$1"
  s="${s#"${s%%[![:space:]]*}"}"
  s="${s%"${s##*[![:space:]]}"}"
  printf "%s" "$s"
}

parse_kv() {
  local line="$1"
  local key="${line%%=*}"
  local val="${line#*=}"
  key="$(trim "$key")"
  val="$(trim "$val")"
  printf "%s\037%s" "$key" "$val"
}

esc() {
  local s="$1"
  s="${s//&/&amp;}"
  s="${s//</&lt;}"
  s="${s//>/&gt;}"
  s="${s//\"/&quot;}"
  s="${s//\'/&apos;}"
  printf "%s" "$s"
}

color_or_none() {
  local v="$1"
  case "$v" in
    transparent|none) printf "none" ;;
    *) printf "#%s" "$v" ;;
  esac
}

accent_color() {
  local name="$1"
  case "$name" in
    green|yellow|orange|red|blue|strong|neutral)
      printf "var(--accent-%s)" "$name"
      ;;
    *)
      if [[ "$name" =~ ^#?[[:xdigit:]]{3}([[:xdigit:]]{3})?$ ]]; then
        if [[ "$name" == \#* ]]; then
          printf "%s" "$name"
        else
          printf "#%s" "$name"
        fi
      else
        printf "var(--accent-neutral)"
      fi
      ;;
  esac
}

parse_config() {
  local conf_file="$1"
  local line kv key val

  while IFS= read -r line || [[ -n "$line" ]]; do
    line="$(trim "$line")"
    [[ -z "$line" ]] && continue
    [[ "$line" == \#* ]] && continue

    kv="$(parse_kv "$line")"
    key="${kv%%$'\037'*}"
    val="${kv#*$'\037'}"

    if [[ "$key" == "item" ]]; then
      items+=("$val")
      continue
    fi

    case "$key" in
      caption) caption="$val" ;;
      cols) cols="$val" ;;
      width) width="$val" ;;
      height) height="$val" ;;
      gap) gap="$val" ;;
      padding) padding="$val" ;;
      bg) bg="$val" ;;
      bg_dark) bg_dark="$val" ;;
      title) title="$val" ;;
      title_dark) title_dark="$val" ;;
      label) label="$val" ;;
      label_dark) label_dark="$val" ;;
      border) border="$val" ;;
      border_dark) border_dark="$val" ;;
      card) card="$val" ;;
      card_dark) card_dark="$val" ;;
      green|yellow|orange|red|blue|strong|neutral) printf -v "$key" "%s" "$val" ;;
      green_dark|yellow_dark|orange_dark|red_dark|blue_dark|strong_dark|neutral_dark) printf -v "$key" "%s" "$val" ;;
    esac
  done < "$conf_file"
}

if [[ "${1:-}" == "-v" || "${1:-}" == "--version" ]]; then
  echo "repocard v$version"
  exit 0
fi

conf_file="${1:-.repocard.conf}"

if [[ ! -f "$conf_file" ]]; then
  echo "missing config: $conf_file" >&2
  exit 1
fi

parse_config "$conf_file"

if [[ "${#items[@]}" -eq 0 ]]; then
  items=("No data|neutral|Add items")
fi

if [[ "$cols" -lt 1 ]]; then cols=1; fi

item_count="${#items[@]}"
if [[ "$cols" -gt "$item_count" ]]; then cols="$item_count"; fi
rows=$(( (item_count + cols - 1) / cols ))

title_block=0
if [[ -n "$caption" ]]; then
  title_block=$((title_height + 8))
fi

svg_width=$((padding * 2 + cols * width + (cols - 1) * gap))
svg_height=$((padding * 2 + rows * height + (rows - 1) * gap + title_block))

font_stack='"Segoe UI","Helvetica Neue",Arial,"Noto Sans",sans-serif'

bg_fill="$(color_or_none "$bg")"
bg_fill_dark="$(color_or_none "$bg_dark")"
card_fill="var(--card)"
border_stroke="var(--border)"

echo "<!-- Generated with repocard v${version} (https://github.com/dannyben/repocard) -->"
echo "<svg xmlns='http://www.w3.org/2000/svg' width='${svg_width}' height='${svg_height}' viewBox='0 0 ${svg_width} ${svg_height}'>"
echo "<style>"
echo "  :root {"
echo "    color-scheme: light dark;"
echo "    --title: #${title};"
echo "    --label: #${label};"
echo "    --border: #${border};"
echo "    --card: #${card};"
echo "    --bg: ${bg_fill};"
echo "    --accent-green: #${green};"
echo "    --accent-yellow: #${yellow};"
echo "    --accent-orange: #${orange};"
echo "    --accent-red: #${red};"
echo "    --accent-blue: #${blue};"
echo "    --accent-strong: #${strong};"
echo "    --accent-neutral: #${neutral};"
echo "  }"
echo "  @media (prefers-color-scheme: dark) {"
echo "    :root {"
echo "      --title: #${title_dark};"
echo "      --label: #${label_dark};"
echo "      --border: #${border_dark};"
echo "      --card: #${card_dark};"
echo "      --bg: ${bg_fill_dark};"
echo "      --accent-green: #${green_dark};"
echo "      --accent-yellow: #${yellow_dark};"
echo "      --accent-orange: #${orange_dark};"
echo "      --accent-red: #${red_dark};"
echo "      --accent-blue: #${blue_dark};"
echo "      --accent-strong: #${strong_dark};"
echo "      --accent-neutral: #${neutral_dark};"
echo "    }"
echo "  }"
echo "  .title { font-family: ${font_stack}; font-size: 16px; font-weight: 600; fill: var(--title); }"
echo "  .label { font-family: ${font_stack}; font-size: 11px; font-weight: 600; letter-spacing: 0.6px; fill: var(--label); }"
echo "  .value { font-family: ${font_stack}; font-size: 16px; font-weight: 600; }"
echo "  .card { fill: ${card_fill}; stroke: ${border_stroke}; }"
echo "</style>"
echo "<rect x='0' y='0' width='${svg_width}' height='${svg_height}' fill='var(--bg)' />"

if [[ -n "$caption" ]]; then
  echo "<text x='${padding}' y='$((padding + 18))' class='title'>$(esc "$caption")</text>"
fi

start_y=$((padding + title_block))

i=0
for item in "${items[@]}"; do
  label="${item%%|*}"
  rest="${item#*|}"
  color="${rest%%|*}"
  value="${rest#*|}"

  row=$((i / cols))
  col=$((i % cols))
  x=$((padding + col * (width + gap)))
  y=$((start_y + row * (height + gap)))

  accent="$(accent_color "$color")"

  echo "<rect x='${x}' y='${y}' width='${width}' height='${height}' class='card' />"
  echo "<rect x='${x}' y='${y}' width='${width}' height='6' fill='${accent}' />"
  echo "<text x='$((x + 10))' y='$((y + 25))' class='label'>$(esc "${label^^}")</text>"
  echo "<text x='$((x + 10))' y='$((y + 50))' class='value' fill='${accent}'>$(esc "$value")</text>"

  i=$((i + 1))
done

echo "</svg>"
