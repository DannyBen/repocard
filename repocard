#!/usr/bin/env bash
# Simple SVG generator driven by .repocard.conf
# Usage: repocard > repocard.svg

set -euo pipefail

version=0.1.1

if [[ "${1:-}" == "-v" || "${1:-}" == "--version" ]]; then
  echo "repocard v$version"
  exit 0
fi

conf_file="${1:-.repocard.conf}"

if [[ ! -f "$conf_file" ]]; then
  echo "missing config: $conf_file" >&2
  exit 1
fi

# Defaults (keep minimal, fixed sizing)
layout="standard"
caption="Repo Card"
cols=4
width=180
height=65
gap=12
padding=16
title_height=28
bg="f7f7f5"
title="1f2328"
label="5a6572"
border="e6e6e2"
card="ffffff"

green="1a7f37"
yellow="b78103"
orange="d16c00"
red="cc3344"
blue="0b62d6"
black="1f2328"
grey="6b7280"

items=()
caption_set=0
bg_set=0
padding_set=0

trim() {
  local s="$1"
  s="${s#"${s%%[![:space:]]*}"}"
  s="${s%"${s##*[![:space:]]}"}"
  printf "%s" "$s"
}

parse_kv() {
  local line="$1"
  local key="${line%%=*}"
  local val="${line#*=}"
  key="$(trim "$key")"
  val="$(trim "$val")"
  printf "%s\037%s" "$key" "$val"
}

while IFS= read -r line || [[ -n "$line" ]]; do
  line="$(trim "$line")"
  [[ -z "$line" ]] && continue
  [[ "$line" == \#* ]] && continue

  kv="$(parse_kv "$line")"
  key="${kv%%$'\037'*}"
  val="${kv#*$'\037'}"

  if [[ "$key" == "item" ]]; then
    items+=("$val")
    continue
  fi

  case "$key" in
    layout)
      layout="$val"
      if [[ "$layout" == "compact" ]]; then
        if [[ "$caption_set" -eq 0 ]]; then caption=""; fi
        if [[ "$bg_set" -eq 0 ]]; then bg="none"; fi
        if [[ "$padding_set" -eq 0 ]]; then padding=0; fi
      fi
      ;;
    caption) caption="$val" ;;
    cols) cols="$val" ;;
    width) width="$val" ;;
    height) height="$val" ;;
    gap) gap="$val" ;;
    padding) padding="$val"; padding_set=1 ;;
    bg) bg="$val"; bg_set=1 ;;
    title) title="$val" ;;
    label) label="$val" ;;
    border) border="$val" ;;
    card) card="$val" ;;
    green|yellow|orange|red|blue|black|grey) printf -v "$key" "%s" "$val" ;;
  esac

  if [[ "$key" == "caption" ]]; then
    caption_set=1
  fi
done < "$conf_file"

if [[ "${#items[@]}" -eq 0 ]]; then
  items=("No data|grey|Add items")
fi

if [[ "$cols" -lt 1 ]]; then cols=1; fi

item_count="${#items[@]}"
if [[ "$cols" -gt "$item_count" ]]; then cols="$item_count"; fi
rows=$(( (item_count + cols - 1) / cols ))

title_block=0
if [[ -n "$caption" ]]; then
  title_block=$((title_height + 8))
fi

svg_width=$((padding * 2 + cols * width + (cols - 1) * gap))
svg_height=$((padding * 2 + rows * height + (rows - 1) * gap + title_block))

font_stack='"Segoe UI","Helvetica Neue",Arial,"Noto Sans",sans-serif'

esc() {
  local s="$1"
  s="${s//&/&amp;}"
  s="${s//</&lt;}"
  s="${s//>/&gt;}"
  s="${s//\"/&quot;}"
  s="${s//\'/&apos;}"
  printf "%s" "$s"
}

color_or_none() {
  local v="$1"
  case "$v" in
    transparent|none) printf "none" ;;
    *) printf "#%s" "$v" ;;
  esac
}

bg_fill="$(color_or_none "$bg")"
card_fill="$(color_or_none "$card")"
border_stroke="$(color_or_none "$border")"

echo "<!-- Generated with repocard v${version} (https://github.com/dannyben/repocard) -->"
echo "<svg xmlns='http://www.w3.org/2000/svg' width='${svg_width}' height='${svg_height}' viewBox='0 0 ${svg_width} ${svg_height}'>"
echo "<style>"
echo "  .title { font-family: ${font_stack}; font-size: 16px; font-weight: 600; fill: #${title}; }"
echo "  .label { font-family: ${font_stack}; font-size: 11px; font-weight: 600; letter-spacing: 0.6px; fill: #${label}; }"
echo "  .value { font-family: ${font_stack}; font-size: 16px; font-weight: 600; }"
echo "  .card { fill: ${card_fill}; stroke: ${border_stroke}; }"
echo "</style>"
echo "<rect x='0' y='0' width='${svg_width}' height='${svg_height}' fill='${bg_fill}' />"

if [[ -n "$caption" ]]; then
  echo "<text x='${padding}' y='$((padding + 18))' class='title'>$(esc "$caption")</text>"
fi

start_y=$((padding + title_block))

i=0
for item in "${items[@]}"; do
  label="${item%%|*}"
  rest="${item#*|}"
  color="${rest%%|*}"
  value="${rest#*|}"

  row=$((i / cols))
  col=$((i % cols))
  x=$((padding + col * (width + gap)))
  y=$((start_y + row * (height + gap)))

  accent="$grey"
  case "$color" in
    green|yellow|orange|red|blue|black|grey) accent="${!color}" ;;
  esac

  echo "<rect x='${x}' y='${y}' width='${width}' height='${height}' class='card' />"
  echo "<rect x='${x}' y='${y}' width='${width}' height='6' fill='#${accent}' />"
  echo "<text x='$((x + 10))' y='$((y + 25))' class='label'>$(esc "${label^^}")</text>"
  echo "<text x='$((x + 10))' y='$((y + 50))' class='value' fill='#${accent}'>$(esc "$value")</text>"

  i=$((i + 1))
done

echo "</svg>"
